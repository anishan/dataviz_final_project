<!DOCTYPE html>

<html>

  <head>

    <meta charset="utf-8">

    <style>

body {
   background: #ffffff;
}

.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

path {
  stroke: white;
  stroke-width: 0.25px;
  fill: #1aff66;
}

    </style>

    <script src="http://d3js.org/d3.v3.min.js"></script>

  </head>

  <body>

    <svg class="centered" id="svg-map"></svg>

    <script>


window.addEventListener("load", run);

var GLOBAL =
{
    data: []
};

function run ()
{

    // world-topo.json is a GeoJSON file, not a TopoJSON file
    // so there's nothing special to be done
    d3.csv("data/refugees.csv", function(data)
    {
      GLOBAL.data = data;
      console.log("LOADED DATA");
      console.log(data);
      // console.log(data[0]["Country / territory of asylum/residence"]);

        d3.json("world-topo.json", function(error,topology)
            {
            // attachVALToWorldData(topology,data);
            drawMap(topology);
            });
    });

}

// function attachVALToWorldData (world,data)
// {

//     var features = world.features;
//     var f;

//     for (var i=0; i<features.length; i++)
//     {
//     	f = hasVAL(features[i].id,"2014",data);
//     	if (f)
//         {
//     	    features[i]["hasVAL"] = true;
//     	    features[i]["VAL"] = f;
//     	}
//         else
//         {
//     	    features[i]["hasVAL"] = false;
//     	}
//     }
// }


// function hasVAL (country, year, data) {
//     for (var i=0; i < data.length; i++)
//     {
//     	if (lookupCountry(data[i]["Country / territory of asylum/residence"]) === country && data[i]["Year"]===year)
//         {
//     	    return data[i]["Total Population"];
//     	}
//     }
//     return false;
// }

function lookupCountry(country)
{
    for(val in countryCodeMap)
    {
        if(country == val[1])
        {
            console.log(val[0])
            return val[0];
        }
    }
}

var countryCodeMap = [
    ["USA",'US'],
    ["CHN",'China'],
    ["JPN",'Japan'],
    ["GBR",'UK'],
    ["KOR",'South Korea'],
    ["NOR",'Norway'],
    ["CAN",'Canada'],
    ["SWE",'Sweden'],
    ["NLD",'Netherlands'],
    ["DEU",'Germany'],
    ["SGP",'Singapore'],
    ["DNK",'Denmark'],
    ["CHE",'Switzerland'],
    ["FRA",'France'],
    ["AUS",'Australia'],
    ["FIN",'Finland'],
    ["NZL",'New Zealand'],
    ["LUX",'Luxembourg'],
    ["BEL",'Belgium'],
    ["AUT",'Austria'],
    ["IND",'India'],
    ["HKG",'Hong Kong'],
    ["ARE",'United Arab Emirates'],
    ["ISR",'Israel'],
    ["IRL",'Ireland'],
    ["POL",'Poland'],
    ["RUS",'Russia'],
    ["TWN",'Taiwan'],
    ["HUN",'Hungary'],
    ["BRA",'Brazil'],
    ["CZE",'Czech Republic'],
    ["ESP",'Spain'],
    ["MYS",'Malaysia'],
    ["ITA",'Italy'],
    ["VNM",'Vietnam'],
    ["TUR",'Turkey'],
    ["CHL",'Chile'],
    ["IDN",'Indonesia'],
    ["PRT",'Portugal'],
    ["MEX",'Mexico'],
    ["SAU",'Saudi Arabia'],
    ["PHL",'Philippines'],
    ["BGR",'Bulgaria'],
    ["THA",'Thailand'],
    ["ROU",'Romania'],
    ["COL",'Colombia'],
    ["PER",'Peru'],
    ["GRC",'Greece'],
    ["EGY",'Egypt'],
    ["ZAF",'South Africa'],
    ["VEN",'Venezuela'],
    ["ARG",'Argentina'],
    ["KEN",'Kenya'],
    ["NGA",'Nigeria'],
    ["UKR",'Ukraine']
]



/*
 * BROWSER SIZE
 *
 */

function availableWidth ()
{
    return Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
}

function availableHeight ()
{
    return Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
}



/*
 * COLORS
 *
 */

var color_CountryBaseVAL = "#1aff66";
// var color_background = "#003a5b";
// var highlightColor = "#a4d15e";

var saved_height = 0;
var saved_width = 0;

/*
 * DRAW THE MAP
 *
 */

function drawMap (world)
{

    console.log(world.features);

    /* size to fill the space but keep aspect ratio */

    var availWidth = availableWidth()-50;
    var availHeight = availableHeight()-50;

    var mapWidth = 760;
    var mapHeight = 380;

    var scaleH = availHeight / mapHeight;
    var scaleW = availWidth / mapWidth;

    var scale = Math.min(scaleH,scaleW);

    var height = scale * mapHeight;
    var width = scale * mapWidth;

    saved_height = height;
    saved_width = width;

    var svg = d3.select("#svg-map")
	.attr("x",0)
	.attr("y",0)
	.attr("width", width)
	.attr("height", height)

    var g = svg.append("g")
	.attr("transform","scale("+scale+"),translate(-150,0)");

    var projection = d3.geo.mercator()
	.center([0, 0 ])
	.scale(100)
	.rotate([0,0]);

    var path = d3.geo.path()
	.projection(projection);

    var max_VAL = d3.max(GLOBAL.data,function (r) { return r["Total Population"]; });

    var country = g.selectAll(".country")   // select country objects (which don't exist yet)
	.data(world.features)  // bind data to these non-existent objects
	.enter()
	.append("path") // prepare data to be appended to paths
	.attr("class", "country")
	.attr("id", function(d) { return "code_" + d.id; })  // give each a unique id, just in case
	.attr("d", path) // create them using the svg path generator defined above
        // color each country based on VAL (set to opacity 0 if no VAL)
	.style("fill", color_CountryBaseVAL)
    .style("stroke", "blue")
    .style("fill-opacity",function(d) {if (d.hasVAL) { return d.VAL / max_VAL; } else { return 0; } })

    // hide antarctica (maybe not needed...)
    d3.select("#code_ATA")
        .attr("visibility","hidden");

}
    </script>

  </body>

</html>
